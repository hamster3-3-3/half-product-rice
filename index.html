<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç±³é£¯æ„Ÿå®˜è©•æ¸¬å„€è¡¨æ¿ | Rice Sensory Evaluation Dashboard</title>
    
    <!-- æ‰€æœ‰çš„ CSS å’Œ JS åº«éƒ½é€é CDN è¼‰å…¥ï¼Œéå¸¸é©åˆéœæ…‹ç¶²ç«™è¨—ç®¡ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f5f5f4; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px; 
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* ç•¥å¾®ç¸®å°ä»¥é©æ‡‰å…©æ¬„ä½ˆå±€ */
            max-height: 400px;
        }
        @media (max-width: 640px) {
            .chart-container { height: 250px; }
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px; 
            height: 18px;
            border-radius: 50%;
            background: #0d9488;
            cursor: pointer;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
            margin-top: -8px; 
        }
        input[type="range"] {
             height: 4px;
             margin-top: 4px;
        }
        /* è©•æ¸¬è€…å…ƒæ•¸æ“šå§‹çµ‚ç‚ºä¸‰æ¬„ */
        .input-meta-grid {
             display: grid;
             grid-template-columns: repeat(3, minmax(0, 1fr));
             gap: 1rem; /* gap-4 */
        }
        /* å®šç¾©æ¯å€‹æ¨£å“çµ„ä»¶å…§éƒ¨çš„ä½ˆå±€ (è¡¨å–®+åœ–è¡¨) */
        .sample-content-grid {
             display: grid;
             grid-template-columns: 1fr;
             gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .sample-content-grid {
                grid-template-columns: 2fr 3fr; /* 2/5 for sliders, 3/5 for chart on desktop */
            }
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 font-sans leading-relaxed selection:bg-teal-100 selection:text-teal-900">

    <!-- Header & Navigation -->
    <header class="bg-white border-b border-stone-200 shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-teal-600 rounded-full flex items-center justify-center text-white font-bold text-xl">ç±³</div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-stone-900 tracking-tight">ç±³é£¯æ„Ÿå®˜è©•æ¸¬</h1>
                    <p class="text-xs text-stone-500 uppercase tracking-wider hidden sm:block">Rice Blind Tasting Assessment</p>
                </div>
            </div>
            <div class="flex space-x-2 sm:space-x-3">
                
                <!-- è¼¸å‡ºæ•¸æ“šæŒ‰éˆ• (ä¸‹è¼‰æ‰€æœ‰æ¨£å“çš„æ•¸æ“š) -->
                <button id="submitBtn" class="bg-teal-600 hover:bg-teal-700 text-white text-sm font-medium py-2 px-3 sm:px-4 rounded-lg shadow-md transition-colors flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z" clip-rule="evenodd" />
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span id="submitBtnText">ä¸‹è¼‰æ‰€æœ‰æ¨£å“ CSV è¡¨æ ¼</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 md:py-8 space-y-8 md:space-y-12">

        <!-- Intro Section -->
        <section class="max-w-4xl mx-auto text-center space-y-3">
            <h2 class="text-2xl md:text-3xl font-bold text-stone-800">åŠæˆå“(ç±³é£¯)ç›²æ¸¬è©•åˆ†æ¨™æº–</h2>
            <p class="text-base text-stone-600 max-w-2xl mx-auto">
                è«‹é€éå…­å¤§æ„Ÿå®˜æŒ‡æ¨™ï¼ˆå¤–è§€ã€æ°£å‘³ã€è»Ÿç¡¬ã€ç²˜åº¦ã€å½ˆåŠ›ã€å‘³é“ï¼‰å°æ‰€æœ‰æ¨£å“é€²è¡Œå…¨æ–¹ä½è©•ä¼°ã€‚
            </p>
        </section>

        <!-- Samples Container: æ‰€æœ‰å‹•æ…‹ç”Ÿæˆçš„è©•æ¸¬å€å¡Šå°‡è¢«åŠ å…¥åˆ°é€™è£¡ -->
        <div id="samples-container" class="max-w-6xl mx-auto space-y-8">
            <!-- Dynamic Sample Blocks will be injected here -->
        </div>

        <!-- æ–°å¢æ¨£å“æŒ‰éˆ• (ç§»å‹•åˆ° samples-container ä¹‹å¾Œ) -->
        <div class="max-w-6xl mx-auto pt-4 pb-2">
            <button id="addNewSampleBtn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-xl transition-colors shadow-lg shadow-teal-300/50 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                æ–°å¢æ¨£å“è©•æ¸¬æ•¸æ“š (å±•é–‹ä¸€å€‹æ–°çš„è©•æ¸¬å€å¡Š)
            </button>
        </div>


        <!-- Reference Guide (Scoring Notes) -->
        <section class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
            <div class="bg-red-50 border border-red-100 rounded-xl p-5 hover:shadow-md transition-shadow">
                <div class="flex items-center gap-3 mb-2">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-red-100 text-red-600 font-bold">1</span>
                    <h4 class="font-bold text-red-800">æ¥µå·® (Poor)</h4>
                </div>
                <p class="text-sm text-red-700 leading-snug">ç„¡æ³•æ¥å—çš„å“è³ªæˆ–ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼šæœ‰ç•°å‘³ã€å¤¾ç”Ÿã€è‰²æ¾¤ç°æš—ã€‚</p>
            </div>

            <div class="bg-yellow-50 border border-yellow-100 rounded-xl p-5 hover:shadow-md transition-shadow">
                 <div class="flex items-center gap-3 mb-2">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-yellow-100 text-yellow-700 font-bold">3</span>
                    <h4 class="font-bold text-yellow-800">æ™®é€š (Average)</h4>
                </div>
                <p class="text-sm text-yellow-800 leading-snug">å“è³ªå°šå¯ï¼Œé”åˆ°åŸºæœ¬é£Ÿç”¨æ¨™æº–ï¼Œä½†æ²’æœ‰çªå‡ºçš„å„ªé»æˆ–æ˜é¡¯çš„è¨˜æ†¶é»ã€‚</p>
            </div>

             <div class="bg-teal-50 border border-teal-100 rounded-xl p-5 hover:shadow-md transition-shadow">
                 <div class="flex items-center gap-3 mb-2">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-teal-100 text-teal-700 font-bold">5</span>
                    <h4 class="font-bold text-teal-800">æ¥µä½³ (Excellent)</h4>
                </div>
                <p class="text-sm text-teal-800 leading-snug">é ‚ç´šå“è³ªï¼Œç‰¹æ€§å®Œç¾ã€‚ä¾‹å¦‚ï¼šå…‰æ¾¤èª˜äººã€é¦™æ°£æ¿ƒéƒã€å£æ„Ÿçµ•ä½³ã€‚</p>
            </div>
        </section>

    </main>

    <footer class="bg-stone-800 text-stone-400 py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 Rice Blind Tasting Assessment System.</p>
        </div>
    </footer>

    <!-- Javascript Logic -->
    <script>
        // å„²å­˜æ‰€æœ‰æ´»èºçš„ SampleComponent å¯¦ä¾‹
        let sampleComponents = new Map();
        let sampleCounter = 0; 
        
        // è©•åˆ†ç¶­åº¦
        const scoreKeys = ['appearance', 'aroma', 'texture', 'viscosity', 'elasticity', 'taste'];
        const scoreLabels = ['å¤–è§€', 'æ°£å‘³', 'è»Ÿç¡¬', 'ç²˜åº¦', 'å½ˆåŠ›', 'å‘³é“'];
        const scoreNotes = {
            appearance: 'å®Œæ•´åº¦ã€è‰²æ¾¤ã€å…‰æ¾¤',
            aroma: 'ç±³é£¯é¦™å‘³ã€æ–°é®®åº¦',
            texture: 'ç±³ç²’è»Ÿç¡¬åº¦',
            viscosity: 'ç±³é£¯é»æ€§ã€æŠ±åœ˜æ€§',
            elasticity: 'ç±³é£¯å½ˆæ€§ã€å’€åš¼æ„Ÿ',
            taste: 'ç±³é£¯ç”œåº¦ã€é®®å‘³'
        };

        // è¼”åŠ©å‡½æ•¸ï¼šç”Ÿæˆå–®å€‹æ»‘æ¡¿çš„ HTML
        const generateSliderHtml = (key, inputPrefix, valPrefix) => `
            <div>
                <div class="flex justify-between mb-1">
                    <label class="text-sm font-medium text-stone-700">${scoreLabels[scoreKeys.indexOf(key)]} (${key.charAt(0).toUpperCase() + key.slice(1)})</label>
                    <span class="text-sm font-bold text-teal-600" id="${valPrefix}${key}">3</span>
                </div>
                <input type="range" min="1" max="5" step="1" value="3" id="${inputPrefix}${key}" data-key="${key}" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                <p class="text-xs text-stone-400 mt-1">${scoreNotes[key]}</p>
            </div>
        `;

        // æ¨£å“çµ„ä»¶ HTML æ¨¡æ¿
        const sampleTemplate = (sampleId, initialAssessor, initialDepartment) => {
            const uniqueId = `sample-${sampleId}`; 
            const inputPrefix = `input-${sampleId}-`;
            const valPrefix = `val-${sampleId}-`;
            
            // ç”Ÿæˆæ»‘æ¡¿åˆ—è¡¨
            const slidersHtml = scoreKeys.map(key => generateSliderHtml(key, inputPrefix, valPrefix)).join('');
            
            return `
                <div id="${uniqueId}" class="sample-component bg-white rounded-2xl shadow-xl border border-stone-200 p-5 sm:p-6 transition-all duration-300">
                    <!-- æ¨™é¡Œå’Œæ¨£å“ ID é¡¯ç¤º -->
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-teal-800 flex items-center gap-2">
                            <span>&#9998;</span> è©•æ¸¬æ•¸æ“šè¼¸å…¥
                        </h3>
                        <span class="text-xs font-mono bg-stone-100 text-stone-500 px-2 py-1 rounded" data-id-display>æ¨£å“ç·¨è™Ÿ: ${sampleId}</span>
                    </div>

                    <!-- å…ƒæ•¸æ“š (Assessor, Department, ID) -->
                    <div class="input-meta-grid mb-6">
                        <div>
                            <label for="${inputPrefix}assessor" class="block text-xs font-semibold text-stone-500 mb-1">è©•æ¸¬è€…</label>
                            <input type="text" id="${inputPrefix}assessor" value="${initialAssessor}" class="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                        </div>
                        
                        <div>
                            <label for="${inputPrefix}department" class="block text-xs font-semibold text-stone-500 mb-1">éƒ¨é–€</label>
                            <input type="text" id="${inputPrefix}department" value="${initialDepartment}" class="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-teal-500 transition-colors">
                        </div>
                        
                        <div>
                            <label for="${inputPrefix}id" class="block text-xs font-semibold text-stone-500 mb-1">æ¨£å“ç·¨è™Ÿ</label>
                            <input type="text" id="${inputPrefix}id" value="${sampleId}" class="w-full bg-stone-50 border border-stone-200 rounded-lg px-3 py-2 text-sm font-bold text-teal-700 focus:outline-none focus:border-teal-500 transition-colors">
                        </div>
                    </div>

                    <!-- è©•åˆ†æ»‘æ¡¿èˆ‡é›·é”åœ– -->
                    <div class="sample-content-grid">
                        <!-- Left: Sliders -->
                        <div>
                            <div class="space-y-5">${slidersHtml}</div>
                        </div>

                        <!-- Right: Chart -->
                        <div class="bg-stone-50 rounded-xl p-4 border border-stone-100 flex items-center justify-center">
                            <div class="chart-container">
                                <canvas id="${uniqueId}-radarChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- ç¸½åˆ†ã€è©•è«–èˆ‡åˆªé™¤æŒ‰éˆ• -->
                    <div class="mt-8 pt-6 border-t border-stone-200 grid grid-cols-1 md:grid-cols-2 gap-6">
                         <!-- Overall Score (ç¾åœ¨æ˜¯è‡ªå‹•è¨ˆç®—çµæœï¼Œä¸å¯ç·¨è¼¯) -->
                        <div>
                            <label class="block text-sm font-bold text-stone-700 mb-2">æ•´é«”åˆ†æ•¸ (ç¸½å’Œ x 2)</label>
                            <div class="flex items-center gap-4">
                                <span id="${valPrefix}totalScore" class="text-2xl font-bold text-teal-700">36</span>
                                <span class="text-stone-400">/ 60 (æ»¿åˆ†)</span>
                            </div>
                        </div>
                        <!-- Delete Button -->
                        <div class="flex justify-end items-end">
                            <button data-delete-id="${uniqueId}" class="delete-btn text-sm text-red-500 hover:text-red-700 transition-colors flex items-center gap-1 p-2 rounded-lg hover:bg-red-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                </svg>
                                ç§»é™¤æ­¤æ¨£å“
                            </button>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label for="${inputPrefix}comments" class="block text-sm font-bold text-stone-700 mb-2">æ¨£å“è©•åƒ¹å…§å®¹ (Comments)</label>
                        <textarea id="${inputPrefix}comments" class="w-full h-24 bg-stone-50 border border-stone-200 rounded-lg p-3 text-sm focus:outline-none focus:border-teal-500 resize-none" placeholder="æè¿°å„ªç¼ºé»ã€ç‰¹æ®Šé¢¨å‘³..."></textarea>
                    </div>
                </div>
            `;
        };

        /**
         * SampleComponent é¡åˆ¥: ç®¡ç†å–®ä¸€æ¨£å“çš„æ‰€æœ‰ç‹€æ…‹ã€è¼¸å…¥å’Œåœ–è¡¨ã€‚
         */
        function SampleComponent(id, initialAssessor, initialDepartment) {
            this.id = id;
            this.uniqueId = `sample-${id}`;
            this.inputPrefix = `input-${id}-`;
            this.valPrefix = `val-${id}-`;
            this.chartId = `${this.uniqueId}-radarChart`;
            this.chartInstance = null;
            
            // æ•¸æ“šåˆå§‹åŒ– (æ•´é«”åˆ†æ•¸ now defaults to 36, based on 6x3*2)
            this.data = {
                assessor: initialAssessor,
                department: initialDepartment,
                id: id,
                scores: { appearance: 3, aroma: 3, texture: 3, viscosity: 3, elasticity: 3, taste: 3 },
                total: 36, // 3 * 6 * 2 = 36
                comments: ""
            };
            
            // æ¸²æŸ“ HTML åˆ°å®¹å™¨
            this.render = () => {
                const container = document.getElementById('samples-container');
                const template = sampleTemplate(this.id, this.data.assessor, this.data.department);
                container.insertAdjacentHTML('beforeend', template);
                this.element = document.getElementById(this.uniqueId);
            };
            
            // è¨ˆç®—æ•´é«”åˆ†æ•¸ (å…­é …åˆ†æ•¸ç¸½å’Œ * 2)
            this.calculateTotalScore = () => {
                const sum = Object.values(this.data.scores).reduce((a, b) => a + b, 0);
                this.data.total = sum * 2;
                document.getElementById(`${this.valPrefix}totalScore`).innerText = this.data.total;
            };

            // æŠ“å–ç•¶å‰è¡¨å–®æ•¸æ“šä¸¦æ›´æ–°å…§éƒ¨ç‹€æ…‹
            this.updateDataFromInputs = () => {
                this.data.assessor = document.getElementById(`${this.inputPrefix}assessor`).value.trim();
                this.data.department = document.getElementById(`${this.inputPrefix}department`).value.trim(); 
                this.data.id = document.getElementById(`${this.inputPrefix}id`).value.trim();
                this.data.comments = document.getElementById(`${this.inputPrefix}comments`).value.trim(); 
                
                scoreKeys.forEach(key => {
                    const value = document.getElementById(`${this.inputPrefix}${key}`).value;
                    // å°‡æ»‘æ¡¿å€¼å¼·åˆ¶è½‰ç‚ºæ•´æ•¸ (1-5)
                    this.data.scores[key] = Math.round(parseFloat(value)); 
                });
                
                // *** é‡è¦è®Šæ›´ï¼šè‡ªå‹•è¨ˆç®—ç¸½åˆ† ***
                this.calculateTotalScore();

                // æ›´æ–°é¡¯ç¤ºçš„æ¨£å“ ID
                this.element.querySelector('[data-id-display]').innerText = `æ¨£å“ç·¨è™Ÿ: ${this.data.id}`;

                this.updateChart();
            };

            // åˆå§‹åŒ– Chart.js
            this.initChart = (ctx) => {
                return new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: scoreLabels,
                        datasets: [
                            {
                                label: this.data.id,
                                data: Object.values(this.data.scores),
                                borderColor: 'rgba(13, 148, 136, 1)', 
                                backgroundColor: 'rgba(13, 148, 136, 0.4)',
                                borderWidth: 2,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: 'rgba(13, 148, 136, 1)',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(13, 148, 136, 1)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0,
                                max: 5,
                                ticks: { stepSize: 1, display: false },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                angleLines: { color: 'rgba(0, 0, 0, 0.05)' },
                                pointLabels: { font: { size: 12 }, color: '#44403c' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.label}: ${context.formattedValue}`
                                }
                            }
                        }
                    }
                });
            };
            
            // æ›´æ–° Chart.js æ•¸æ“š
            this.updateChart = () => {
                if (this.chartInstance) {
                    this.chartInstance.data.datasets[0].data = Object.values(this.data.scores);
                    this.chartInstance.data.datasets[0].label = this.data.id;
                    this.chartInstance.update();
                }
            };
            
            // è¨­ç½®æ‰€æœ‰è¼¸å…¥æ¬„ä½çš„äº‹ä»¶ç›£è½å™¨
            this.setupListeners = () => {
                // è©•åˆ†æ»‘æ¡¿å’Œæ•¸å€¼é¡¯ç¤ºåŒæ­¥
                scoreKeys.forEach(key => {
                    const slider = document.getElementById(`${this.inputPrefix}${key}`);
                    const display = document.getElementById(`${this.valPrefix}${key}`);
                    slider.addEventListener('input', (e) => {
                        const val = Math.round(parseFloat(e.target.value)); 
                        display.innerText = val;
                        this.updateDataFromInputs(); // è§¸ç™¼æ•¸æ“šæ›´æ–°å’Œåœ–è¡¨é‡ç¹ª
                    });
                });

                // å…¶ä»–æ–‡å­—è¼¸å…¥æ¬„ä½ (ç¸½åˆ†å·²ç§»é™¤)
                [`${this.inputPrefix}assessor`, `${this.inputPrefix}department`, `${this.inputPrefix}id`, `${this.inputPrefix}comments`].forEach(id => {
                     document.getElementById(id).addEventListener('input', this.updateDataFromInputs);
                });
                
                // åˆªé™¤æŒ‰éˆ•
                this.element.querySelector('.delete-btn').addEventListener('click', () => {
                    removeSampleComponent(this.id);
                });
            };
            
            // åˆå§‹åŒ–æµç¨‹
            this.render();
            const ctxRadar = document.getElementById(this.chartId).getContext('2d');
            this.chartInstance = this.initChart(ctxRadar);
            this.setupListeners();
            // ç¢ºä¿åˆå§‹æ•¸æ“šå’Œåœ–è¡¨åŒæ­¥
            this.updateDataFromInputs(); 
        }

        /**
         * ç§»é™¤ä¸€å€‹æ¨£å“çµ„ä»¶ã€‚
         * @param {string} id - æ¨£å“ IDã€‚
         */
        function removeSampleComponent(id) {
            if (sampleComponents.size === 1) {
                // å¦‚æœåªå‰©ä¸€å€‹ï¼Œé˜»æ­¢åˆªé™¤ä¸¦æç¤ºç”¨æˆ¶
                console.warn("è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ¨£å“è©•æ¸¬å€å¡Šã€‚");
                return;
            }
            const component = sampleComponents.get(id);
            if (component) {
                // éŠ·æ¯€ Chart.js å¯¦ä¾‹ä»¥é‡‹æ”¾å…§å­˜
                component.chartInstance.destroy();
                // å¾ DOM ä¸­ç§»é™¤å…ƒç´ 
                component.element.remove();
                // å¾ Map ä¸­ç§»é™¤çµ„ä»¶
                sampleComponents.delete(id);
            }
        }

        /**
         * æ–°å¢ä¸€å€‹æ–°çš„æ¨£å“çµ„ä»¶ã€‚
         */
        function addNewSampleComponent() {
            sampleCounter++;
            const newId = `S-${String(sampleCounter).padStart(3, '0')}`;
            
            // å˜—è©¦ä¿ç•™ä¸Šä¸€å€‹æ¨£å“çš„è©•æ¸¬è€…å’Œéƒ¨é–€ (å¦‚æœæœ‰)
            let lastAssessor = "è©•æ¸¬å“¡ A";
            let lastDepartment = "ç ”ç™¼éƒ¨";

            if (sampleComponents.size > 0) {
                const lastComponent = Array.from(sampleComponents.values()).pop();
                // ç¢ºä¿æˆ‘å€‘å–å¾—çš„æ˜¯ç•¶å‰è¼¸å…¥çš„æœ€æ–°å€¼
                lastComponent.updateDataFromInputs(); 
                lastAssessor = lastComponent.data.assessor;
                lastDepartment = lastComponent.data.department;
            }

            const newComponent = new SampleComponent(newId, lastAssessor, lastDepartment);
            sampleComponents.set(newId, newComponent);
        }
        
        /**
         * åŒ¯å‡ºæ‰€æœ‰æ´»èºæ¨£å“çµ„ä»¶çš„æ•¸æ“šç‚º CSV æ–‡ä»¶ã€‚
         */
        function exportToCsv() {
            if (sampleComponents.size === 0) {
                console.error('éŒ¯èª¤ï¼šæ²’æœ‰æ•¸æ“šå¯ä»¥åŒ¯å‡ºã€‚è«‹æ–°å¢ä¸€å€‹æ¨£å“è©•æ¸¬å€å¡Šã€‚');
                return;
            }

            const submitBtnText = document.getElementById('submitBtnText');
            const originalText = submitBtnText.innerText;
            submitBtnText.innerText = 'æ­£åœ¨æº–å‚™...';
            
            // 1. ç¢ºä¿æ‰€æœ‰çµ„ä»¶éƒ½æ›´æ–°äº†å…§éƒ¨æ•¸æ“š
            const allData = Array.from(sampleComponents.values()).map(comp => {
                comp.updateDataFromInputs(); // ç¢ºä¿å¾è¼¸å…¥æ¬„ä½æŠ“å–æœ€æ–°å€¼
                return comp.data;
            });

            // 2. å®šç¾© CSV æ¨™é ­
            const headers = [
                "è©•æ¸¬è€…", "éƒ¨é–€", "æ¨£å“ç·¨è™Ÿ", ...scoreLabels, "æ•´é«”åˆ†æ•¸ (ç¸½åˆ†x2)", "æ¨£å“è©•åƒ¹å…§å®¹"
            ];
            
            // 3. æº–å‚™æ•¸æ“šè¡Œ (å¤šè¡Œ)
            const csvRows = allData.map(data => {
                // è™•ç†è©•è«–ä¸­çš„é€—è™Ÿå’Œæ›è¡Œç¬¦
                const commentsCsvSafe = `"${(data.comments || '').replace(/"/g, '""').replace(/\n/g, ' ') }"`;
                
                return [
                    data.assessor,
                    data.department, 
                    data.id,
                    data.scores.appearance,
                    data.scores.aroma,
                    data.scores.texture,
                    data.scores.viscosity,
                    data.scores.elasticity,
                    data.scores.taste,
                    // é€™è£¡ä½¿ç”¨è‡ªå‹•è¨ˆç®—çš„ç¸½åˆ† (å·²åœ¨ updateDataFromInputs ä¸­è¨ˆç®—)
                    data.total, 
                    commentsCsvSafe
                ].join(',');
            });
            
            // 4. çµ„åˆ CSV å…§å®¹
            const csvContent = headers.join(',') + '\n' + csvRows.join('\n');
            
            // 5. å‰µå»º Blob ä¸¦ä¸‹è¼‰
            const blob = new Blob(['\ufeff', csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.setAttribute('href', url);
            
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, ''); 
            const filename = `Rice_Evaluations_Batch_${timestamp}_${sampleComponents.size}samples.csv`;
            a.setAttribute('download', filename);
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // æä¾›è¦–è¦ºåé¥‹
            submitBtnText.innerText = 'ä¸‹è¼‰å®Œæˆ! ğŸ’¾';
            setTimeout(() => { 
                submitBtnText.innerText = originalText; 
            }, 2000);
        }

        // --- Init ---
        window.addEventListener('DOMContentLoaded', () => {
            // 1. åˆå§‹åŒ–ç¬¬ä¸€å€‹æ¨£å“
            addNewSampleComponent(); 

            // 2. è¨­ç½®æŒ‰éˆ•ç›£è½å™¨
            document.getElementById('addNewSampleBtn').addEventListener('click', addNewSampleComponent);
            document.getElementById('submitBtn').addEventListener('click', exportToCsv);
            
            // ç”±æ–¼æ¡ç”¨å¤šçµ„ä»¶æ¨¡å¼ï¼Œé‡ç½®æŒ‰éˆ•åŠŸèƒ½å·²ç§»é™¤ (ç”±å–®å€‹æ¨£å“çš„åˆªé™¤æŒ‰éˆ•å–ä»£ï¼Œæˆ–ç”±ä½¿ç”¨è€…æ‰‹å‹•é‡è¨­å€¼)
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) resetBtn.remove();
        });

    </script>
</body>
</html>
